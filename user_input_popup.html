<!DOCTYPE html>
<html>
<head></head>
<body>

<h1>Popup window for user to enter their data</h1> 
<br>
<label id="user_input_label" style="display:block;">[Step 0] Enter user_input</label>
<br>
<input id="user_input" type="text" value="" placeholder="user_input" rows="10" cols="100" style="display:block; text-align: left; width: 600px;">
<br>
<input id="auth2" type="text" value="" placeholder="auth2" rows="10" cols="100" style="display:block; text-align: left; width: 600px;">
<br>
<button id="treat_frontend_data_to_trigger_backend" onclick="treat_frontend_data_to_trigger_backend()">Submit</button>
<br>
<div id="error" style="display:block; font-family:courier; font-size:24px; height:300px;"></div>
<div id="notification" style="display:block; font-family:courier; font-size:24px; height:300px;"></div>


<!-- ---------------------------------------- -->
<!-- CSS -->
<style>
div#notification { position: relative; color: #3236a8; }
div#error { position: relative; color: #bd1f17; }

input { box_sizing: border-box; border: 1px solid #5f9341; margin-bottom: 4px; width: 100%; padding-left: 10px; padding-right: 10px; padding-bottom: 10px; padding-top: 10px; }

button {background: #5f9341; color: white; padding: 10px 20px; border: none; font-weight: bold; }
  
</style>


<script>

const repoOwner = 'CodeSolutions2';
const repoName = 'github_actions_practice';



async function treat_frontend_data_to_trigger_backend() {

  await GET_text_from_file_wo_auth_GitHub_RESTAPI()
    .then(async function(auth) { await PUT_create_a_file_RESTAPI(auth); })
    .catch(error => { document.getElementById("error").innerHTML = error; });

}


async function remove_characters_from_str(str_to_clean, arr_of_char_to_remove) {

	// str_to_clean should be a string
	// (Example) arr_of_char_to_remove = ['"', "'", " ", "\n"]
	let str_to_clean_char_arr = str_to_clean.split('');
	console.log('str_to_clean_char_arr:', str_to_clean_char_arr);
	
	arr_of_char_to_remove.forEach(async function(char, index) {
		const NoVal = (num) => num != char;
		str_to_clean_char_arr = str_to_clean_char_arr.filter(NoVal);
	});
	return str_to_clean_char_arr.join('');
}

// ----------------------------------------------------
// PUT create a file - Way 0: REST API (WORKS!)
// Can only write to a public repository, can not write to a private repository even if the key grants access
// https://docs.github.com/en/rest/repos/contents?apiVersion=2022-11-28#create-or-update-file-contents
// ----------------------------------------------------
async function PUT_create_a_file_RESTAPI(auth) {
  
    var message = 'add user input to file for backend';
    var content = document.getElementById("user_input").value;
    var auth2 = document.getElementById("auth2").value;
  
    // https://developer.mozilla.org/en-US/docs/Web/API/btoa
    var content_encoded0 = btoa(content);
    // console.log("content_encoded0: ", content_encoded0);

    // Ensure that spaces are removed from auth
    auth = auth.replace(/\s/g, '');
    
    // PUT into a new file
    var url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/temp.txt`;
    var data = {"message": message, "committer":{"name":"App name","email":"App email"}, "content": content_encoded0};
    var headers = {"Accept": "application/vnd.github+json", "Authorization": `Bearer ${auth2}`, "X-GitHub-Api-Version": "2022-11-28"};
    var options = {method : 'PUT', headers: headers, body : JSON.stringify(data)};
    return await fetch(url, options)
      .then(res => { console.log(res); return res; })
      .then(async function() { document.getElementById("notification").innerHTML = "Thank you for submiting data, please close the popup window"; })
      .catch(error => { document.getElementById("error").innerHTML = error; });

}
  
// ----------------------------------------------------

async function loop_over_files_and_folders(data, desired_filename, file_download_url, folders) {
	// run through files per url directory
	data.forEach(async function(file) {
		// console.log("file: ", file);
		var regexp = new RegExp(`${desired_filename}`, 'g');
		
		if (file.type === 'file' && file.name.match(regexp)) { 
			file_download_url = file.download_url;
		} else if (file.type === 'dir') {
			// Store url of directories found
			folders.push(file.url);
		}
	});

	return {file_download_url: file_download_url, folders: folders}; 
}

async function GET_text_from_file_wo_auth_GitHub_RESTAPI() {
	
	var url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents`;

	var desired_filename = "lp.txt"; 
  
	var file_download_url = [];
	var folders = [];
	var flag = "run";
	var max_loop_limit = 0;
	
	return await fetch(url)
		.then(res => res.json())
		.then(async function(data) { 

			while (flag == "run" || max_loop_limit < 5) {
				// search over data for the desired_filename
				var obj = await loop_over_files_and_folders(data, desired_filename, file_download_url, folders);

				folders = folders.concat(obj.folders);
				folders = [... new Set(folders)];
				// console.log("folders: ", folders);
				
				file_download_url = file_download_url.concat(obj.file_download_url);
				file_download_url = [... new Set(file_download_url)];
				// console.log("file_download_url: ", file_download_url);
				// console.log("folders.length: ", folders.length);
				
				// get list of folders from the main directory
				if (folders.length == 0) {
					flag = "stop";
					if (file_download_url.length == 0) {
						file_download_url = "No file found";
					}
				} else {
					// There are directories in the main file
					
					// remove url from folders
					let new_url = folders.shift();
					// console.log("new_url: ", new_url);
					// console.log("folders: ", folders);

					// fetch data from url
					data = await fetch(new_url)
						.then(res => res.json())
						.then(async function(data) { return data; });
				}
				max_loop_limit += 1;
				// console.log("max_loop_limit: ", max_loop_limit);
			}
			
			return file_download_url;
		})
		.then(async function (file_download_url) { 
			var text_out = "";
			if (file_download_url != "No file found") {
				// fetch on first file
				text_out = await fetch(file_download_url[0])
					.then(response => response.text())
					.then(async function(text_out) { return text_out; });
			}
			console.log("text_out: ", text_out);
			return text_out;
		})
		.catch(error => { document.getElementById("error").innerHTML = error; });
}

</script>

  </body>
</html>
